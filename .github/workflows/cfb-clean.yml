name: cfb clean
on:
  push:
    paths: 
      - ".github/workflows/cfb-clean.yml"
  
jobs:
  step1:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    strategy:
      fail-fast: false
      matrix:
        channel_id: [25, 143, 230, 229]
    steps:
      - name: Checkout cfb storage
        if: success()
        uses: actions/checkout@v2
        with:
          path: storage
          ref: "cfb-storage"
      - name: Clean
        run: |
          cd storage/${{matrix.channel_id}}/threads
          ls ./ | while read line; do [ -d $line ] && echo $line && rm -fr $line; done
      - name: push
        if: success()
        run: |
          cd storage
          git add -A
          [ `git status -s | wc -l` != 0 ] && \
          git commit -q -m "cfb clean ${{matrix.channel_id}}"
          for i in $(seq 1 5); do
            echo "push start ##########################"
            git push && exit 0 || git pull -q --rebase
            sleep 5
            echo "retry ${i}."
          done
          exit 1
