name: crawlers
on: push
#  schedule:
#    - cron: '*/2 * * * *'

jobs:
  step1:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        channel_id: [25, 143, 230]
    steps:
      - uses: actions/checkout@v2
        with:
          path: bin
          ref: 'cfb'
      - uses: actions/checkout@v2
        with:
          path: storage
          ref: 'cfb-storage'
      - uses: actions/setup-node@v1
      - uses: actions/setup-python@v1
      - name: Install Dependencies
        run: |
          npm i -g typescript ts-node
          python -m pip install requests
          npm i puppeteer fs-extra
      - name: init folder and file
        run: chmod +x bin/init.sh; bin/init.sh ${{ matrix.channel_id }}
      - name: dec bin
        run: find bin -type f -name '*.enc' | while read line; do openssl enc -d -aes256 -k ${{secrets.cfb_password}} -in $line -out "${line::-4}"; rm -f ${line}; done
      - name: crawlar page
        run: |
          mkdir -p checkpoint/${{ matrix.channel_id }}
          p=$(cat storage/${{ matrix.channel_id }}/page);
          echo $p
          node bin/step1.js $p > /dev/null
          find checkpoint -type f | wc -l
          find checkpoint/ -type f | while read line; do openssl enc -aes256 -k ${{secrets.cfb_password}} -in $line -out "${line}.enc" > /dev/null ; rm -f ${line}; done
          # mv checkpoint storage/
          cp -r checkpoint/* storage/
          echo $(($p+1)) > storage/${{ matrix.channel_id }}/page
          cd storage
          git branch -a
          git branch
          echo 11111111111
          git pull
          git add -A ${{ matrix.channel_id }}
          git config --global user.name ${GITHUB_ACTOR}
          git config --global user.email ${GITHUB_ACTOR}@my-domain.io
          git commit -q -m "c page ${p}"
          for i in $(seq 1 5); do
            git pull
            git push
            if [[ "$?" == "0" ]]; then
              exit 0
            fi
            sleep 5
            echo "retry ${i}."
          done
          
        env:
          channel_id: ${{ matrix.channel_id }}
#       - name: enc thread info file
#         run: find checkpoint/ -type f | while read line; do openssl enc -aes256 -k ${{secrets.cfb_password}} -in $line -out "${line}.enc"; rm -f ${line}; done
#       - name: test
#         run: find checkpoint -type f | wc -l
# #       - name: dec thread info file
# #         run: find test/ -type f -name '*.json.enc' | while read line; do openssl enc -d -aes256 -k ${{secrets.cfb_password}} -in $line -out "${line::-4}"; rm -f ${line}; done
#   step2:
#     runs-on: ubuntu-latest
#     steps:
#       - run: openssl -h
