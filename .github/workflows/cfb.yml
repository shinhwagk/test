name: crawlers
on: push
#  schedule:
#    - cron: '*/2 * * * *' 

jobs:
  step1:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        channel_id: [25, 143, 230]
    steps:
      - uses: actions/checkout@v2
        with:
          path: bin
          ref: 'cfb'
      - uses: actions/setup-node@v1
      - uses: actions/setup-python@v1
      - run: npm i -g typescript ts-node
      - run: python -m pip install requests
      - run: npm i puppeteer fs-extra
      - name: dec bin
        run: find bin -type f -name '*.enc' | while read line; do openssl enc -d -aes256 -k ${{secrets.cfb_password}} -in $line -out "${line::-4}"; rm -f ${line}; done
      - name: step1
        run: node bin/step1.js > /dev/null
        env:
          channel_id: ${{ matrix.channel_id }}
      - name: nameï¼šenc thread info file
        run: find checkpoint/ -type f | while read line; do openssl enc -aes256 -k ${{secrets.cfb_password}} -in $line -out "${line}.enc"; rm -f ${line}; done
      - run: |
          sleep=$[$RANDOM%10]
          sleep $sleep
          git config --global user.name ${GITHUB_ACTOR}
          git config --global user.email ${GITHUB_ACTOR}@my-domain.io
          git add checkpoint
          git commit -q -m "crawler channel: ${{ matrix.channel_id }}, page:$(cat checkpoint/${{ matrix.channel_id }}/page )"
          git pull -q;
          git push;
          echo "##########################################"
#       - name: dec thread info file
#         run: find test/ -type f -name '*.json.enc' | while read line; do openssl enc -d -aes256 -k ${{secrets.cfb_password}} -in $line -out "${line::-4}"; rm -f ${line}; done
  step2:
    runs-on: ubuntu-latest
    steps:
      - run: openssl -h
